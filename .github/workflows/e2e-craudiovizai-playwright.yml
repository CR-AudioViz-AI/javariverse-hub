name: E2E Tests - Full Surface

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - smoke
          - discovery
          - public-surface
          - auth
          - apps

permissions:
  contents: read
  issues: write

env:
  E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
  E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

jobs:
  # Smoke test for PRs (fast gate)
  smoke-test:
    name: Smoke Test (PR Gate)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: npm install
      
      - name: Run smoke tests
        run: npx playwright test tests/e2e/smoke.spec.ts --config=playwright.config.ts
      
      - name: Upload smoke results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # Full suite for push to main, schedule, and manual dispatch
  full-suite:
    name: Full E2E Suite
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: npm install
      
      - name: Create output directories
        run: |
          mkdir -p test-results/routes
          mkdir -p test-results/apps
          mkdir -p test-results/auth
      
      - name: Determine test files
        id: tests
        run: |
          if [ "${{ github.event.inputs.suite }}" = "smoke" ]; then
            echo "files=tests/e2e/smoke.spec.ts" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.suite }}" = "discovery" ]; then
            echo "files=tests/e2e/00-discovery.spec.ts" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.suite }}" = "public-surface" ]; then
            echo "files=tests/e2e/10-public-surface.spec.ts" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.suite }}" = "auth" ]; then
            echo "files=tests/e2e/20-auth.spec.ts" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.suite }}" = "apps" ]; then
            echo "files=tests/e2e/30-apps-tools.spec.ts" >> $GITHUB_OUTPUT
          else
            echo "files=tests/e2e/" >> $GITHUB_OUTPUT
          fi
      
      - name: Run E2E tests
        id: e2e
        run: |
          set +e
          npx playwright test ${{ steps.tests.outputs.files }} --config=playwright.config.ts 2>&1 | tee test-output.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Copy manifest to OPS if exists
        if: always()
        run: |
          if [ -f test-results/E2E_COVERAGE_MANIFEST.json ]; then
            cp test-results/E2E_COVERAGE_MANIFEST.json OPS/E2E_COVERAGE_MANIFEST.json 2>/dev/null || true
          fi
      
      - name: Upload full results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-full-results-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
            test-output.log
            OPS/E2E_COVERAGE_MANIFEST.json
          retention-days: 30
      
      - name: Check for existing P0 issue
        id: check-issue
        if: steps.e2e.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e-failure',
              state: 'open',
              per_page: 10
            });
            
            // Check if there's a recent issue (within last 24 hours)
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recentIssue = issues.data.find(issue => 
              new Date(issue.created_at) > oneDayAgo
            );
            
            if (recentIssue) {
              console.log('Found recent issue:', recentIssue.number);
              return { exists: true, number: recentIssue.number };
            }
            return { exists: false };
      
      - name: Create P0 issue on failure
        if: steps.e2e.outputs.exit_code != '0' && steps.check-issue.outputs.result != '{"exists":true}'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let output = '';
            try {
              output = fs.readFileSync('test-output.log', 'utf8');
            } catch (e) {
              output = 'Could not read test output';
            }
            
            // Extract failure summary
            const failedTests = output.match(/\d+ failed/g) || [];
            const errorLines = output.split('\n').filter(l => 
              l.includes('Error:') || l.includes('expect(') || l.includes('✗')
            ).slice(0, 20);
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const timestamp = new Date().toISOString();
            
            // Generate signature for deduplication
            const signature = errorLines.slice(0, 3).join('').replace(/[^a-zA-Z]/g, '').substring(0, 50);
            
            const body = `## P0: E2E Full Surface Test Failure
            
**Severity:** P0 - Production Validation Failed
**Target:** https://craudiovizai.com
**Suite:** Full Surface Coverage
**Workflow Run:** ${runUrl}
**Timestamp:** ${timestamp}
**Signature:** \`${signature}\`

### Summary
${failedTests.length > 0 ? failedTests.join(', ') : 'Tests failed'}

### Error Details
\`\`\`
${errorLines.join('\n').substring(0, 3000)}
\`\`\`

### Artifacts
- [Playwright HTML Report](${runUrl}#artifacts)
- [Test Results JSON](${runUrl}#artifacts)
- [Screenshots & Traces](${runUrl}#artifacts)

### Coverage Manifest
Check \`OPS/E2E_COVERAGE_MANIFEST.json\` for full route/link inventory.

---
*Auto-generated by E2E Full Surface CI*
*Signature for dedupe: ${signature}*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[P0] E2E Full Surface Failure - craudiovizai.com',
              body: body,
              labels: ['bug', 'P0', 'e2e-failure']
            });
      
      - name: Update existing issue
        if: steps.e2e.outputs.exit_code != '0' && steps.check-issue.outputs.result == '{"exists":true}'
        uses: actions/github-script@v7
        with:
          script: |
            const result = ${{ steps.check-issue.outputs.result }};
            if (result.exists && result.number) {
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: result.number,
                body: `### Additional failure detected\n\nRun: ${runUrl}\nTime: ${new Date().toISOString()}`
              });
            }
      
      - name: Fail if tests failed
        if: steps.e2e.outputs.exit_code != '0'
        run: exit 1
      
      - name: Success
        if: steps.e2e.outputs.exit_code == '0'
        run: |
          echo "✅ All E2E tests passed"
          echo "Full surface coverage verified"
