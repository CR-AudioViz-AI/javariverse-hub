name: E2E Full Coverage - craudiovizai.com

on:
  schedule:
    # Nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - smoke
          - discovery
          - auth
          - apps-tools

permissions:
  contents: read
  issues: write

env:
  E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
  E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

jobs:
  e2e-full:
    name: Full Coverage Suite
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    timeout-minutes: 45
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Determine test files
        id: tests
        run: |
          SUITE="${{ github.event.inputs.suite || 'full' }}"
          case "$SUITE" in
            smoke)
              echo "files=tests/e2e/craudiovizai.critical.spec.ts" >> $GITHUB_OUTPUT
              ;;
            discovery)
              echo "files=tests/e2e/00-discovery.spec.ts" >> $GITHUB_OUTPUT
              ;;
            auth)
              echo "files=tests/e2e/20-auth.spec.ts" >> $GITHUB_OUTPUT
              ;;
            apps-tools)
              echo "files=tests/e2e/30-apps-tools.spec.ts" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "files=" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Run Playwright tests
        id: tests_run
        run: |
          set +e
          if [ -n "${{ steps.tests.outputs.files }}" ]; then
            npx playwright test ${{ steps.tests.outputs.files }} 2>&1 | tee test-output.log
          else
            npx playwright test 2>&1 | tee test-output.log
          fi
          TEST_EXIT=$?
          echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT
          exit 0

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-full-results-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
            test-output.log
          retention-days: 30

      - name: Copy manifest to OPS
        if: always()
        run: |
          if [ -f test-results/E2E_COVERAGE_MANIFEST.json ]; then
            mkdir -p OPS
            cp test-results/E2E_COVERAGE_MANIFEST.json OPS/E2E_COVERAGE_MANIFEST.json
            echo "Manifest copied to OPS/"
          fi

      - name: Check for existing P0 issue
        id: check_issue
        if: steps.tests_run.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e-failure,P0',
              state: 'open',
              per_page: 10,
            });
            
            // Check for duplicate (same run signature)
            const today = new Date().toISOString().split('T')[0];
            const existing = issues.data.find(i => 
              i.title.includes('[E2E-Full]') && 
              i.body.includes(today)
            );
            
            if (existing) {
              console.log('Found existing issue:', existing.number);
              core.setOutput('exists', 'true');
              core.setOutput('issue_number', existing.number);
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Create P0 issue on failure
        if: steps.tests_run.outputs.exit_code != '0' && steps.check_issue.outputs.exists != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let output = 'No output captured';
            try {
              output = fs.readFileSync('test-output.log', 'utf8');
            } catch (e) {}
            
            // Extract failure summary
            const lines = output.split('\n');
            const failureLines = lines.filter(l => 
              l.includes('FAIL') || l.includes('Error') || l.includes('âœ˜')
            ).slice(0, 20);
            
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const timestamp = new Date().toISOString();
            
            let body = `## ðŸš¨ E2E Full Coverage Failure\n\n`;
            body += `**Severity:** P0 - Production Issue Detected\n`;
            body += `**Target:** https://craudiovizai.com\n`;
            body += `**Suite:** ${{ github.event.inputs.suite || 'full' }}\n`;
            body += `**Run:** ${runUrl}\n`;
            body += `**Timestamp:** ${timestamp}\n\n`;
            
            body += `### Failed Tests\n\`\`\`\n`;
            body += failureLines.join('\n') || output.substring(output.length - 2000);
            body += `\n\`\`\`\n\n`;
            
            body += `### Artifacts\n`;
            body += `- [Playwright Report](${runUrl}#artifacts)\n`;
            body += `- [Test Results](${runUrl}#artifacts)\n`;
            body += `- [Screenshots & Traces](${runUrl}#artifacts)\n\n`;
            
            body += `### Next Steps\n`;
            body += `1. Download artifacts from workflow run\n`;
            body += `2. Review \`playwright-report/index.html\`\n`;
            body += `3. Check \`test-results/*.json\` for details\n`;
            body += `4. Fix and push to main\n\n`;
            
            body += `---\n*Auto-generated by E2E Full Coverage CI*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[E2E-Full] Coverage failure on craudiovizai.com - ${timestamp.split('T')[0]}`,
              body: body,
              labels: ['bug', 'P0', 'e2e-failure', 'full-coverage'],
            });

      - name: Update existing issue
        if: steps.tests_run.outputs.exit_code != '0' && steps.check_issue.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.check_issue.outputs.issue_number }};
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ”„ Additional failure detected\n\nRun: ${runUrl}\nTime: ${new Date().toISOString()}`
            });

      - name: Fail if tests failed
        if: steps.tests_run.outputs.exit_code != '0'
        run: exit 1

      - name: Success
        if: steps.tests_run.outputs.exit_code == '0'
        run: |
          echo "âœ… All E2E tests passed"
          echo "Full coverage verified on craudiovizai.com"
